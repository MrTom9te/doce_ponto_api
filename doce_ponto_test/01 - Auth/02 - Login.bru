meta {
  name: 02 - Login
  type: http
  seq: 2
}

post {
  url: {{baseUrl}}/auth/login
  body: json
  auth: none
}

body:json {
  {
    "email": "{{userEmail}}",
    "password": "{{userPassword}}"
  }
}

script:post-response {
  // Salva o token de autenticação
  if (res.getStatus() === 200) {
    bru.setVar("authToken", res.getBody().data.token);
  }
}

tests {
  test("Login deve ser bem-sucedido com credenciais válidas", function() {
    // 1. Verifica o código de status
    expect(res.getStatus()).to.equal(200);

    // 2. Verifica a estrutura geral da resposta
    expect(res.getBody().success).to.be.true;
    expect(res.getBody().message).to.equal("Login realizado com sucesso");
    expect(res.getBody().data).to.not.be.null;

    // 3. Verifica a presença e o tipo do token
    expect(res.getBody().data).to.have.property("token");
    expect(res.getBody().data.token).to.be.a('string').and.to.not.be.empty;

    // 4. Verifica a estrutura do objeto de usuário retornado
    const user = res.getBody().data.user;
    expect(user).to.not.be.null;
    expect(user.id).to.be.a('string');
    expect(user.name).to.be.a('string');
    expect(user.email).to.equal(bru.getVar("userEmail"));
  });

  test("Login com credenciais inválidas deve falhar", function() {
    // Este teste seria em uma requisição separada com credenciais inválidas.
    // expect(res.status).to.equal(401);
    // expect(res.getBody().code).to.equal("INVALID_CREDENTIALS");
  });
}

docs {
  **Autentica o usuário criado no passo anterior.**

  Utiliza as variáveis `{{userEmail}}` and `{{userPassword}}` que foram salvas no ambiente pelo teste de Registro.

  **Ações Pós-Execução:**
  - Se o login for bem-sucedido, extrai o token JWT da resposta.
  - Salva o token na variável de ambiente `authToken` para ser usado em todas as requisições autenticadas subsequentes.
}
